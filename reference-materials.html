<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCERT Study Assistant</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    
    <!-- Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
    
    <!-- EmailJS -->
    <script src="https://cdn.emailjs.com/sdk/3.2.0/email.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-500 to-purple-600 min-h-screen">
    <div class="container mx-auto px-4 py-4 h-screen flex items-center justify-center">
        <div class="w-full max-w-4xl h-[95vh] bg-white rounded-3xl shadow-2xl flex flex-col overflow-hidden">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h1 class="text-xl md:text-2xl font-bold mb-1">üéì NCERT Study Assistant</h1>
                        <p class="text-sm md:text-base opacity-90">AI-powered learning companion</p>
                    </div>
                    <div class="text-xs bg-white/20 px-3 py-1 rounded-full">
                        <span id="statusInfo">Ready</span>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="hidden mx-4 mt-4 p-3 rounded-lg text-sm font-medium"></div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="text-center py-8">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">
                            Welcome to your AI Study Assistant!
                        </h2>
                        <p class="text-gray-600 mb-8 text-sm md:text-base">
                            Ask me anything about your studies - I can explain concepts, solve problems, and help with homework!
                        </p>
                        
                        <!-- Example Questions -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-xl border-2 border-transparent hover:border-blue-500 cursor-pointer transition-all transform hover:scale-105" onclick="askQuestion('Explain photosynthesis in simple terms')">
                                <div class="text-lg font-semibold text-blue-600 mb-2">üå± Photosynthesis</div>
                                <div class="text-sm text-gray-600">How do plants make food?</div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-xl border-2 border-transparent hover:border-blue-500 cursor-pointer transition-all transform hover:scale-105" onclick="askQuestion('What is the water cycle?')">
                                <div class="text-lg font-semibold text-blue-600 mb-2">üíß Water Cycle</div>
                                <div class="text-sm text-gray-600">Water movement in nature</div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-xl border-2 border-transparent hover:border-blue-500 cursor-pointer transition-all transform hover:scale-105" onclick="askQuestion('Explain Newton laws of motion')">
                                <div class="text-lg font-semibold text-blue-600 mb-2">üöÄ Physics</div>
                                <div class="text-sm text-gray-600">Motion and forces</div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-xl border-2 border-transparent hover:border-blue-500 cursor-pointer transition-all transform hover:scale-105" onclick="askQuestion('How does human digestion work?')">
                                <div class="text-lg font-semibold text-blue-600 mb-2">ü´Å Biology</div>
                                <div class="text-sm text-gray-600">Digestive system</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div id="typingIndicator" class="hidden flex items-start space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm">
                        ü§ñ
                    </div>
                    <div class="bg-white p-3 rounded-2xl rounded-bl-none shadow-sm border">
                        <div class="flex items-center space-x-1">
                            <span class="text-gray-600 text-sm">AI is thinking</span>
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-4 bg-white border-t border-gray-200">
                <div class="flex items-end space-x-3">
                    <div class="flex-1">
                        <div class="relative">
                            <textarea 
                                id="messageInput"
                                rows="1"
                                placeholder="Ask me anything about your studies..."
                                class="w-full p-3 pr-12 border-2 border-gray-300 rounded-2xl resize-none focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors text-sm md:text-base"
                                style="max-height: 120px;"
                            ></textarea>
                            <button 
                                id="sendBtn"
                                onclick="sendMessage()"
                                class="absolute right-2 bottom-2 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-colors"
                            >
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M2 21L23 12 2 3V10L17 12 2 14V21Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban Screen -->
    <div id="banScreen" class="hidden fixed inset-0 bg-red-600 bg-opacity-95 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-md w-full text-center">
            <div class="text-4xl mb-4">üö´</div>
            <h2 class="text-2xl font-bold text-red-600 mb-4">Account Suspended</h2>
            <p class="text-gray-600 mb-6">Your account has been suspended for violating community guidelines.</p>
            
            <div class="space-y-4">
                <input type="email" id="unbanEmail" placeholder="Your email" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200">
                <textarea id="unbanReason" placeholder="Reason for unban..." rows="3" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200 resize-none"></textarea>
                <button onclick="sendUnbanRequest()" class="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition-colors">
                    Send Unban Request
                </button>
                
                <div class="pt-4 border-t">
                    <p class="text-sm text-gray-500 mb-2">Admin Override:</p>
                    <div class="flex space-x-2">
                        <input type="password" id="adminCode" placeholder="Admin Code" class="flex-1 p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-200">
                        <button onclick="checkAdminCode()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                            Verify
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOHLoX1OGHiznYvYeUSkrR2lAxzhVrsGw",
            authDomain: "learn-code-with-anay.firebaseapp.com",
            projectId: "learn-code-with-anay",
            storageBucket: "learn-code-with-anay.firebasestorage.app",
            messagingSenderId: "197075143711",
            appId: "1:197075143711:web:64fc5d83528f907d38d92a",
            measurementId: "G-F01VRZK4ZL"
        };

        const emailConfig = {
            serviceID: "service_fnfsdzb",
            templateID: "template_t87ngjb",
            publicKey: "rpRk2Ug-KURSyDb5U"
        };

        const ADMIN_CODE = "290965";
        const MAX_VIOLATIONS = 10;
        const BAN_DURATION = 3 * 24 * 60 * 60 * 1000;

        // Banned words
        const BANNED_WORDS = [
            'stupid', 'idiot', 'fool', 'dumb', 'moron', 'loser', 'hate',
            'kill', 'die', 'death', 'murder', 'violence', 'fight', 'attack',
            'damn', 'hell', 'shit', 'fuck', 'bitch', 'ass', 'bastard'
        ];

        // Global variables
        let db, deviceId, currentUser = null;

        // Initialize immediately
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ NCERT Assistant starting...');
            setupChat();
            initializeServices();
            showStatus('üéâ AI Assistant is ready to help!', 'success');
        });

        function setupChat() {
            const messageInput = document.getElementById('messageInput');
            
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send on Enter (mobile-friendly)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            console.log('‚úÖ Chat ready');
        }

        // Initialize services in background
        async function initializeServices() {
            try {
                // EmailJS
                if (typeof emailjs !== 'undefined') {
                    emailjs.init(emailConfig.publicKey);
                    console.log('‚úÖ EmailJS ready');
                }

                // Firebase
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    console.log('‚úÖ Firebase ready');
                    
                    deviceId = generateDeviceId();
                    await setupUser();
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Some services failed:', error);
            }
        }

        function generateDeviceId() {
            const data = navigator.userAgent + screen.width + navigator.language + Date.now();
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                const char = data.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16).substring(0, 16);
        }

        async function setupUser() {
            try {
                const userRef = db.collection('users').doc(deviceId);
                const doc = await userRef.get();
                
                if (doc.exists) {
                    currentUser = doc.data();
                } else {
                    currentUser = {
                        deviceId: deviceId,
                        violations: [],
                        totalViolations: 0,
                        banExpiry: null,
                        createdAt: firebase.firestore.Timestamp.now()
                    };
                    await userRef.set(currentUser);
                }
                
                updateStatusInfo();
                await checkBanStatus();
                console.log('‚úÖ User ready');
            } catch (error) {
                console.warn('‚ö†Ô∏è User setup failed:', error);
            }
        }

        function updateStatusInfo() {
            document.getElementById('statusInfo').textContent = 
                `${currentUser?.totalViolations || 0}/${MAX_VIOLATIONS} warnings`;
        }

        async function checkBanStatus() {
            if (!currentUser?.banExpiry) return;
            
            const now = new Date();
            const banExpiry = currentUser.banExpiry.toDate();
            
            if (now < banExpiry) {
                document.getElementById('banScreen').classList.remove('hidden');
            }
        }

        // SEND MESSAGE FUNCTION - THIS IS THE KEY PART
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            console.log('üì§ Attempting to send message:', message);
            
            if (!message) {
                console.log('‚ùå Empty message');
                return;
            }

            // Check for profanity
            const isAllowed = await checkMessage(message);
            if (!isAllowed) {
                input.value = '';
                return;
            }

            // Hide welcome screen
            document.getElementById('welcomeScreen').style.display = 'none';
            
            // Add user message
            addMessage('user', message);
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';

            // Show typing and get AI response
            showTyping();
            
            try {
                const response = await getAIResponse(message);
                hideTyping();
                addMessage('assistant', response);
                console.log('‚úÖ Message sent successfully');
            } catch (error) {
                hideTyping();
                console.error('‚ùå AI response failed:', error);
                addMessage('assistant', '‚ùå Sorry, I encountered an error. Please try again.');
            }
        }

        async function checkMessage(message) {
            const words = message.toLowerCase().split(/\s+/);
            const badWords = words.filter(word => 
                BANNED_WORDS.some(banned => word.includes(banned))
            );
            
            if (badWords.length > 0) {
                await recordViolation(badWords, message);
                return false;
            }
            return true;
        }

        async function recordViolation(badWords, message) {
            try {
                if (!currentUser || !db) {
                    showStatus(`‚ö†Ô∏è Warning: Inappropriate language (${badWords.join(', ')})`, 'warning');
                    return;
                }

                const userRef = db.collection('users').doc(deviceId);
                const violation = {
                    timestamp: firebase.firestore.Timestamp.now(),
                    words: badWords,
                    message: message.substring(0, 100)
                };
                
                const updatedViolations = [...currentUser.violations, violation];
                const totalViolations = updatedViolations.length;
                
                let updateData = {
                    violations: updatedViolations,
                    totalViolations: totalViolations,
                    lastViolation: firebase.firestore.Timestamp.now()
                };
                
                if (totalViolations >= MAX_VIOLATIONS) {
                    const banExpiry = new Date(Date.now() + BAN_DURATION);
                    updateData.banExpiry = firebase.firestore.Timestamp.fromDate(banExpiry);
                }
                
                await userRef.update(updateData);
                Object.assign(currentUser, updateData);
                updateStatusInfo();
                
                if (totalViolations >= MAX_VIOLATIONS) {
                    document.getElementById('banScreen').classList.remove('hidden');
                } else {
                    const remaining = MAX_VIOLATIONS - totalViolations;
                    showStatus(`‚ö†Ô∏è Warning: Inappropriate language (${badWords.join(', ')}). ${remaining} warnings left.`, 'warning');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to record violation:', error);
                showStatus(`‚ö†Ô∏è Warning: Inappropriate language (${badWords.join(', ')})`, 'warning');
            }
        }

        async function getAIResponse(message) {
            try {
                // Try Puter.js AI
                if (typeof window.puter !== 'undefined') {
                    console.log('ü§ñ Using Puter.js AI');
                    const response = await puter.ai.chat(
                        `You are a helpful NCERT study assistant for Indian students. Answer this question clearly and educationally: ${message}`
                    );
                    return response.message || response;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Puter.js failed:', error);
            }
            
            // Fallback response
            return `Thank you for asking about "${message.substring(0, 50)}...". I'm currently experiencing some technical difficulties with my AI capabilities. Please check your NCERT textbook or ask your teacher for detailed information on this topic.`;
        }

        function askQuestion(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        function addMessage(sender, content) {
            const container = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                messageDiv.className = 'flex items-start space-x-3 justify-end';
                messageDiv.innerHTML = `
                    <div class="bg-blue-500 text-white p-3 rounded-2xl rounded-br-none shadow-sm max-w-xs md:max-w-md break-words">
                        <p class="text-sm md:text-base">${content}</p>
                        <div class="text-xs opacity-75 mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm">
                        üë§
                    </div>
                `;
            } else {
                messageDiv.className = 'flex items-star
