<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCERT Study Assistant</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    
    <!-- Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
    
    <!-- EmailJS -->
    <script src="https://cdn.emailjs.com/sdk/3.2.0/email.min.js"></script>
    
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --dark: #2c3e50;
            --white: #ffffff;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Loading Screen */
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .loading-screen.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--primary);
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .loading-subtext {
            color: var(--secondary);
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Debug Panel */
        .debug-trigger {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 1001;
        }

        .debug-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            z-index: 1002;
            overflow-y: auto;
            padding: 20px;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-header {
            background: #1a1a1a;
            color: #00ff41;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #00ff41;
        }

        .debug-section {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .debug-section h3 {
            color: #58a6ff;
            margin-bottom: 10px;
            border-bottom: 1px solid #21262d;
            padding-bottom: 5px;
        }

        .debug-log {
            max-height: 200px;
            overflow-y: auto;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }

        .log-entry {
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .log-success { color: #238636; }
        .log-error { color: #f85149; }
        .log-warning { color: #d29922; }
        .log-info { color: #79c0ff; }

        .debug-controls {
            background: #21262d;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }

        .debug-btn {
            background: #238636;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            font-family: monospace;
        }

        .debug-btn:hover {
            background: #2ea043;
        }

        .debug-btn.danger {
            background: #da3633;
        }

        .debug-btn.danger:hover {
            background: #f85149;
        }

        .close-debug {
            position: absolute;
            top: 20px;
            right: 30px;
            background: #da3633;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Chat Interface */
        .chat-header {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .welcome-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .chat-input {
            padding: 20px;
            background: var(--white);
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .chat-textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            font-size: 1rem;
        }

        .chat-textarea:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-message {
            padding: 10px 20px;
            margin: 10px 20px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Hidden Debug Trigger (click to access) -->
        <button class="debug-trigger" onclick="showDebugPanel()" title="Debug Panel"></button>

        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingScreen">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Initializing System...</div>
            <div class="loading-subtext" id="loadingSubtext">Please wait while we set up the services</div>
        </div>

        <!-- Debug Panel (Hidden by default) -->
        <div class="debug-panel" id="debugPanel">
            <button class="close-debug" onclick="hideDebugPanel()">✕ CLOSE</button>
            
            <div class="debug-header">
                <h2>🔧 ADMIN DEBUG SYSTEM</h2>
                <p>Real-time initialization monitoring and system diagnostics</p>
            </div>

            <div class="debug-section">
                <h3>📊 System Status</h3>
                <div id="systemStatus">
                    <div>🔄 Initialization: <span id="initStatus">Not Started</span></div>
                    <div>🔥 Firebase: <span id="firebaseStatus">Not Connected</span></div>
                    <div>🤖 Puter.js: <span id="puterStatus">Not Loaded</span></div>
                    <div>📧 EmailJS: <span id="emailjsStatus">Not Initialized</span></div>
                    <div>🆔 Device ID: <span id="deviceIdStatus">Not Generated</span></div>
                    <div>👤 User Data: <span id="userDataStatus">Not Loaded</span></div>
                </div>
            </div>

            <div class="debug-section">
                <h3>📋 Initialization Log</h3>
                <div class="debug-log" id="debugLog">
                    <div class="log-entry log-info">[INFO] Debug panel initialized</div>
                </div>
            </div>

            <div class="debug-section">
                <h3>🌐 Network & Environment</h3>
                <div id="networkInfo">
                    <div>📡 Online: <span id="onlineStatus">Checking...</span></div>
                    <div>🌐 User Agent: <span id="userAgent">Loading...</span></div>
                    <div>📍 Location: <span id="locationInfo">Detecting...</span></div>
                    <div>🔒 HTTPS: <span id="httpsStatus">Checking...</span></div>
                </div>
            </div>

            <div class="debug-section">
                <h3>❌ Error Details</h3>
                <div class="debug-log" id="errorLog">
                    <div class="log-info">No errors yet...</div>
                </div>
            </div>

            <div class="debug-controls">
                <h3>🎮 Debug Controls</h3>
                <button class="debug-btn" onclick="retryInitialization()">🔄 Retry Init</button>
                <button class="debug-btn" onclick="skipFirebase()">⏭️ Skip Firebase</button>
                <button class="debug-btn" onclick="skipPuter()">⏭️ Skip Puter</button>
                <button class="debug-btn" onclick="forceEnable()">⚡ Force Enable</button>
                <button class="debug-btn" onclick="clearStorage()">🗑️ Clear Storage</button>
                <button class="debug-btn danger" onclick="simulateError()">💥 Test Error</button>
            </div>
        </div>

        <!-- Main Chat Interface -->
        <div class="chat-header">
            <h1>🎓 NCERT Study Assistant</h1>
            <p>AI-powered educational support system</p>
        </div>

        <div class="status-message" id="statusMessage"></div>

        <div class="chat-messages" id="chatMessages">
            <div class="welcome-screen">
                <div>
                    <h2>Welcome to your Study Assistant!</h2>
                    <p>Ask me anything about your studies and I'll help explain concepts clearly.</p>
                </div>
            </div>
        </div>

        <div class="chat-input">
            <textarea id="messageInput" class="chat-textarea" placeholder="Type your question here..." disabled></textarea>
            <button id="sendBtn" class="send-btn" disabled>Send</button>
        </div>
    </div>

    <script>
        // Debug System
        const DEBUG = {
            log: [],
            errors: [],
            status: {
                init: false,
                firebase: false,
                puter: false,
                emailjs: false,
                deviceId: false,
                userData: false
            }
        };

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOHLoX1OGHiznYvYeUSkrR2lAxzhVrsGw",
            authDomain: "learn-code-with-anay.firebaseapp.com",
            projectId: "learn-code-with-anay",
            storageBucket: "learn-code-with-anay.firebasestorage.app",
            messagingSenderId: "197075143711",
            appId: "1:197075143711:web:64fc5d83528f907d38d92a",
            measurementId: "G-F01VRZK4ZL"
        };

        const emailConfig = {
            serviceID: "service_fnfsdzb",
            templateID: "template_t87ngjb",
            publicKey: "rpRk2Ug-KURSyDb5U"
        };

        const SYSTEM_CONFIG = {
            MAX_VIOLATIONS: 10,
            BAN_DURATION: 3 * 24 * 60 * 60 * 1000,
            ADMIN_CODE: "290965"
        };

        // Global variables
        let firebase_app, db, puter, deviceId, currentUser = null;
        let isInitialized = false;

        // Debug Functions
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message, type };
            DEBUG.log.push(entry);
            
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Update debug panel if open
            const debugLogEl = document.getElementById('debugLog');
            if (debugLogEl) {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
                debugLogEl.appendChild(logEntry);
                debugLogEl.scrollTop = debugLogEl.scrollHeight;
            }
        }

        function debugError(message, error) {
            const errorInfo = {
                message,
                error: error?.message || error,
                stack: error?.stack,
                timestamp: new Date().toISOString()
            };
            DEBUG.errors.push(errorInfo);
            
            debugLog(`ERROR: ${message} - ${error?.message || error}`, 'error');
            
            // Update error log
            const errorLogEl = document.getElementById('errorLog');
            if (errorLogEl) {
                const errorEntry = document.createElement('div');
                errorEntry.className = 'log-entry log-error';
                errorEntry.innerHTML = `
                    <strong>[${errorInfo.timestamp}] ${message}</strong><br>
                    Error: ${errorInfo.error}<br>
                    ${errorInfo.stack ? `Stack: ${errorInfo.stack.substring(0, 200)}...` : ''}
                `;
                errorLogEl.appendChild(errorEntry);
                errorLogEl.scrollTop = errorLogEl.scrollHeight;
            }
        }

        function updateDebugStatus(service, status, details = '') {
            DEBUG.status[service] = status;
            
            const statusEl = document.getElementById(`${service}Status`);
            if (statusEl) {
                statusEl.textContent = status ? `✅ ${details || 'Connected'}` : `❌ ${details || 'Failed'}`;
                statusEl.style.color = status ? '#238636' : '#f85149';
            }
        }

        function showDebugPanel() {
            document.getElementById('debugPanel').classList.add('show');
            updateNetworkInfo();
            debugLog('Debug panel opened', 'info');
        }

        function hideDebugPanel() {
            document.getElementById('debugPanel').classList.remove('show');
        }

        function updateNetworkInfo() {
            document.getElementById('onlineStatus').textContent = navigator.onLine ? '✅ Online' : '❌ Offline';
            document.getElementById('userAgent').textContent = navigator.userAgent.substring(0, 100) + '...';
            document.getElementById('httpsStatus').textContent = location.protocol === 'https:' ? '✅ Secure' : '⚠️ HTTP';
            
            // Get timezone
            try {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                document.getElementById('locationInfo').textContent = timezone;
            } catch (e) {
                document.getElementById('locationInfo').textContent = 'Unknown';
            }
        }

        // Debug Controls
        function retryInitialization() {
            debugLog('Manual retry triggered', 'warning');
            location.reload();
        }

        function skipFirebase() {
            debugLog('Skipping Firebase initialization', 'warning');
            updateDebugStatus('firebase', true, 'Skipped');
            continueInitialization();
        }

        function skipPuter() {
            debugLog('Skipping Puter.js initialization', 'warning');
            updateDebugStatus('puter', true, 'Skipped');
            continueInitialization();
        }

        function forceEnable() {
            debugLog('Force enabling chat interface', 'warning');
            document.getElementById('loadingScreen').classList.add('hidden');
            enableChat();
            showStatus('⚡ Chat force-enabled by admin', 'warning');
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            debugLog('All storage cleared', 'warning');
            showStatus('🗑️ Storage cleared', 'success');
        }

        function simulateError() {
            debugError('Simulated error for testing', new Error('Test error from debug panel'));
        }

        function continueInitialization() {
            // Continue with remaining steps
            setTimeout(() => {
                if (!isInitialized) {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    enableChat();
                    showStatus('🎉 System ready! (Some features may be limited)', 'success');
                }
            }, 1000);
        }

        // Main initialization
        document.addEventListener('DOMContentLoaded', async () => {
            debugLog('DOM loaded, starting initialization', 'info');
            updateDebugStatus('init', false, 'Starting');
            
            try {
                await initializeApp();
            } catch (error) {
                debugError('Main initialization failed', error);
                showInitializationError(error.message);
            }
        });

        async function initializeApp() {
            try {
                debugLog('Starting EmailJS initialization', 'info');
                updateLoadingText('Initializing EmailJS...');
                await initializeEmailJS();
                updateDebugStatus('emailjs', true);
                
                debugLog('Starting Firebase initialization', 'info');
                updateLoadingText('Connecting to Firebase...');
                await initializeFirebase();
                updateDebugStatus('firebase', true);
                
                debugLog('Starting Puter.js initialization', 'info');
                updateLoadingText('Loading Puter.js AI...');
                await initializePuter();
                updateDebugStatus('puter', true);
                
                debugLog('Generating device fingerpr
